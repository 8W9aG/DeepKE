<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>deepke.name_entity_re.multimodal.models.clip.file_utils &mdash; DeepKE 0.2.97 documentation</title>
      <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../../../" id="documentation_options" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/clipboard.min.js"></script>
        <script src="../../../../../../_static/copybutton.js"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../../../index.html" class="icon icon-home"> DeepKE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../start.html">Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../deepke.html">DeepKE</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">DeepKE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../../../index.html">Module code</a> &raquo;</li>
      <li>deepke.name_entity_re.multimodal.models.clip.file_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for deepke.name_entity_re.multimodal.models.clip.file_utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2020 The HuggingFace Team, the AllenNLP library authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities for working with the local dataset cache. Parts of this file is adapted from the AllenNLP library at</span>
<span class="sd">https://github.com/allenai/allennlp.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">UserDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span><span class="p">,</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">ContextManager</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">is_zipfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">huggingface_hub</span> <span class="kn">import</span> <span class="n">HfFolder</span><span class="p">,</span> <span class="n">Repository</span><span class="p">,</span> <span class="n">create_repo</span><span class="p">,</span> <span class="n">list_repo_files</span><span class="p">,</span> <span class="n">whoami</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">import</span> <span class="nn">importlib.metadata</span> <span class="k">as</span> <span class="nn">importlib_metadata</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">transformers.utils</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">auto</span> <span class="k">as</span> <span class="n">tqdm_lib</span>

<span class="n">_tqdm_active</span> <span class="o">=</span> <span class="kc">True</span>
<div class="viewcode-block" id="EmptyTqdm"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.EmptyTqdm">[docs]</a><span class="k">class</span> <span class="nc">EmptyTqdm</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Dummy tqdm which doesn&#39;t do anything.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return empty function.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">empty_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">empty_fn</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">return</span></div>
        
<span class="k">class</span> <span class="nc">_tqdm_cls</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_tqdm_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm_lib</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EmptyTqdm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">_tqdm_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm_lib</span><span class="o">.</span><span class="n">tqdm</span><span class="o">.</span><span class="n">set_lock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_tqdm_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm_lib</span><span class="o">.</span><span class="n">tqdm</span><span class="o">.</span><span class="n">get_lock</span><span class="p">()</span>


<span class="n">tqdm</span> <span class="o">=</span> <span class="n">_tqdm_cls</span><span class="p">()</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="n">ENV_VARS_TRUE_VALUES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="s2">&quot;YES&quot;</span><span class="p">,</span> <span class="s2">&quot;TRUE&quot;</span><span class="p">}</span>
<span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span> <span class="o">=</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s2">&quot;AUTO&quot;</span><span class="p">})</span>

<span class="n">USE_TF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USE_TF&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">USE_TORCH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USE_TORCH&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">USE_JAX</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USE_FLAX&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="k">if</span> <span class="n">USE_TORCH</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span> <span class="ow">and</span> <span class="n">USE_TF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="p">:</span>
    <span class="n">_torch_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_torch_available</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_torch_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyTorch version </span><span class="si">{</span><span class="n">_torch_version</span><span class="si">}</span><span class="s2"> available.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="n">_torch_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disabling PyTorch because USE_TF is set&quot;</span><span class="p">)</span>
    <span class="n">_torch_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">if</span> <span class="n">USE_TF</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span> <span class="ow">and</span> <span class="n">USE_TORCH</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="p">:</span>
    <span class="n">_tf_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_tf_available</span><span class="p">:</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;tensorflow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tensorflow-cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tensorflow-gpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tf-nightly&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tf-nightly-cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tf-nightly-gpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;intel-tensorflow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;intel-tensorflow-avx512&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tensorflow-rocm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tensorflow-macos&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_tf_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># For the metadata, we have to look for both tensorflow and tensorflow-cpu</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">_tf_available</span> <span class="o">=</span> <span class="n">_tf_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_tf_available</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">_tf_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TensorFlow found but with version </span><span class="si">{</span><span class="n">_tf_version</span><span class="si">}</span><span class="s2">. Transformers requires version 2 minimum.&quot;</span><span class="p">)</span>
            <span class="n">_tf_available</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TensorFlow version </span><span class="si">{</span><span class="n">_tf_version</span><span class="si">}</span><span class="s2"> available.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disabling Tensorflow because USE_TORCH is set&quot;</span><span class="p">)</span>
    <span class="n">_tf_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">if</span> <span class="n">USE_JAX</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span><span class="p">:</span>
    <span class="n">_flax_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;flax&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_flax_available</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_jax_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span>
            <span class="n">_flax_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;flax&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JAX version </span><span class="si">{</span><span class="n">_jax_version</span><span class="si">}</span><span class="s2">, Flax version </span><span class="si">{</span><span class="n">_flax_version</span><span class="si">}</span><span class="s2"> available.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="n">_flax_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_flax_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_datasets_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Check we&#39;re not importing a &quot;datasets&quot; directory somewhere but the actual library by trying to grab the version</span>
    <span class="c1"># AND checking it has an author field in the metadata that is HuggingFace.</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">)</span>
    <span class="n">_datasets_metadata</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_datasets_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;HuggingFace Inc.&quot;</span><span class="p">:</span>
        <span class="n">_datasets_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_datasets_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_detectron2_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;detectron2&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_detectron2_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;detectron2&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported detectron2 version </span><span class="si">{</span><span class="n">_detectron2_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_detectron2_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_faiss_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;faiss&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_faiss_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;faiss&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported faiss version </span><span class="si">{</span><span class="n">_faiss_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_faiss_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;faiss-cpu&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported faiss version </span><span class="si">{</span><span class="n">_faiss_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
        <span class="n">_faiss_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">coloredlogs</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;coloredlogs&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_coloredlogs_available</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;coloredlogs&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported sympy version </span><span class="si">{</span><span class="n">_coloredlogs_available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_coloredlogs_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">sympy_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sympy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_sympy_available</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;sympy&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported sympy version </span><span class="si">{</span><span class="n">_sympy_available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_sympy_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_tf2onnx_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;tf2onnx&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_tf2onnx_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tf2onnx&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported tf2onnx version </span><span class="si">{</span><span class="n">_tf2onnx_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_tf2onnx_available</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_onnx_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;onnxruntime&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_onxx_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;onnx&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported onnx version </span><span class="si">{</span><span class="n">_onxx_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_onnx_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_scatter_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_scatter&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_scatter_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;torch_scatter&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported torch-scatter version </span><span class="si">{</span><span class="n">_scatter_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_scatter_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_pytorch_quantization_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pytorch_quantization&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_pytorch_quantization_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;pytorch_quantization&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported pytorch-quantization version </span><span class="si">{</span><span class="n">_pytorch_quantization_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_pytorch_quantization_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_soundfile_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;soundfile&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_soundfile_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;soundfile&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported soundfile version </span><span class="si">{</span><span class="n">_soundfile_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_soundfile_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_tensorflow_probability_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;tensorflow_probability&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_tensorflow_probability_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tensorflow_probability&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported tensorflow-probability version </span><span class="si">{</span><span class="n">_tensorflow_probability_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_tensorflow_probability_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_timm_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;timm&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_timm_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;timm&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported timm version </span><span class="si">{</span><span class="n">_timm_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_timm_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_torchaudio_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torchaudio&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_torchaudio_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;torchaudio&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported torchaudio version </span><span class="si">{</span><span class="n">_torchaudio_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_torchaudio_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_phonemizer_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;phonemizer&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_phonemizer_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;phonemizer&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported phonemizer version </span><span class="si">{</span><span class="n">_phonemizer_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_phonemizer_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_pyctcdecode_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pyctcdecode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_pyctcdecode_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;pyctcdecode&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported pyctcdecode version </span><span class="si">{</span><span class="n">_pyctcdecode_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_pyctcdecode_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_librosa_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;librosa&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_librosa_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;librosa&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported librosa version </span><span class="si">{</span><span class="n">_librosa_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_librosa_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">torch_cache_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TORCH_HOME&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;XDG_CACHE_HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.cache&quot;</span><span class="p">),</span> <span class="s2">&quot;torch&quot;</span><span class="p">))</span>
<span class="n">old_default_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">torch_cache_home</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">)</span>
<span class="c1"># New default cache, shared with the Datasets library</span>
<span class="n">hf_cache_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HF_HOME&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;XDG_CACHE_HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.cache&quot;</span><span class="p">),</span> <span class="s2">&quot;huggingface&quot;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">default_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hf_cache_home</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">)</span>

<span class="c1"># Onetime move from the old location to the new one if no ENV variable has been set.</span>
<span class="k">if</span> <span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_default_cache_path</span><span class="p">)</span>
    <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">default_cache_path</span><span class="p">)</span>
    <span class="ow">and</span> <span class="s2">&quot;PYTORCH_PRETRAINED_BERT_CACHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="ow">and</span> <span class="s2">&quot;PYTORCH_TRANSFORMERS_CACHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="ow">and</span> <span class="s2">&quot;TRANSFORMERS_CACHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
<span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;In Transformers v4.0.0, the default path to cache downloaded models changed from &quot;</span>
        <span class="s2">&quot;&#39;~/.cache/torch/transformers&#39; to &#39;~/.cache/huggingface/transformers&#39;. Since you don&#39;t seem to have overridden &quot;</span>
        <span class="s2">&quot;and &#39;~/.cache/torch/transformers&#39; is a directory that exists, we&#39;re moving it to &quot;</span>
        <span class="s2">&quot;&#39;~/.cache/huggingface/transformers&#39; to avoid redownloading models you have already in the cache. You should &quot;</span>
        <span class="s2">&quot;only see this message once.&quot;</span>
    <span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">old_default_cache_path</span><span class="p">,</span> <span class="n">default_cache_path</span><span class="p">)</span>

<span class="n">PYTORCH_PRETRAINED_BERT_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTORCH_PRETRAINED_BERT_CACHE&quot;</span><span class="p">,</span> <span class="n">default_cache_path</span><span class="p">)</span>
<span class="n">PYTORCH_TRANSFORMERS_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTORCH_TRANSFORMERS_CACHE&quot;</span><span class="p">,</span> <span class="n">PYTORCH_PRETRAINED_BERT_CACHE</span><span class="p">)</span>
<span class="n">TRANSFORMERS_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TRANSFORMERS_CACHE&quot;</span><span class="p">,</span> <span class="n">PYTORCH_TRANSFORMERS_CACHE</span><span class="p">)</span>
<span class="n">HF_MODULES_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HF_MODULES_CACHE&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hf_cache_home</span><span class="p">,</span> <span class="s2">&quot;modules&quot;</span><span class="p">))</span>
<span class="n">TRANSFORMERS_DYNAMIC_MODULE_NAME</span> <span class="o">=</span> <span class="s2">&quot;transformers_modules&quot;</span>
<span class="n">SESSION_ID</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
<span class="n">DISABLE_TELEMETRY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DISABLE_TELEMETRY&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span>

<span class="n">WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;pytorch_model.bin&quot;</span>
<span class="n">TF2_WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;tf_model.h5&quot;</span>
<span class="n">TF_WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;model.ckpt&quot;</span>
<span class="n">FLAX_WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;flax_model.msgpack&quot;</span>
<span class="n">CONFIG_NAME</span> <span class="o">=</span> <span class="s2">&quot;config.json&quot;</span>
<span class="n">FEATURE_EXTRACTOR_NAME</span> <span class="o">=</span> <span class="s2">&quot;preprocessor_config.json&quot;</span>
<span class="n">MODEL_CARD_NAME</span> <span class="o">=</span> <span class="s2">&quot;modelcard.json&quot;</span>

<span class="n">SENTENCEPIECE_UNDERLINE</span> <span class="o">=</span> <span class="s2">&quot;▁&quot;</span>
<span class="n">SPIECE_UNDERLINE</span> <span class="o">=</span> <span class="n">SENTENCEPIECE_UNDERLINE</span>  <span class="c1"># Kept for backward compatibility</span>

<span class="n">MULTIPLE_CHOICE_DUMMY_INPUTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Needs to have 0s and 1s only since XLM uses it for langs too.</span>
<span class="n">DUMMY_INPUTS</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
<span class="n">DUMMY_MASK</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="n">S3_BUCKET_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://s3.amazonaws.com/models.huggingface.co/bert&quot;</span>
<span class="n">CLOUDFRONT_DISTRIB_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://cdn.huggingface.co&quot;</span>

<span class="n">_staging_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HUGGINGFACE_CO_STAGING&quot;</span><span class="p">,</span> <span class="s2">&quot;NO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span>
<span class="n">_default_endpoint</span> <span class="o">=</span> <span class="s2">&quot;https://moon-staging.huggingface.co&quot;</span> <span class="k">if</span> <span class="n">_staging_mode</span> <span class="k">else</span> <span class="s2">&quot;https://huggingface.co&quot;</span>

<span class="n">HUGGINGFACE_CO_RESOLVE_ENDPOINT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HUGGINGFACE_CO_RESOLVE_ENDPOINT&quot;</span><span class="p">,</span> <span class="n">_default_endpoint</span><span class="p">)</span>
<span class="n">HUGGINGFACE_CO_PREFIX</span> <span class="o">=</span> <span class="n">HUGGINGFACE_CO_RESOLVE_ENDPOINT</span> <span class="o">+</span> <span class="s2">&quot;/</span><span class="si">{model_id}</span><span class="s2">/resolve/</span><span class="si">{revision}</span><span class="s2">/</span><span class="si">{filename}</span><span class="s2">&quot;</span>

<span class="c1"># This is the version of torch required to run torch.fx features and torch.onnx with dictionary inputs.</span>
<span class="n">TORCH_FX_REQUIRED_VERSION</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.9&quot;</span><span class="p">)</span>
<span class="n">TORCH_ONNX_DICT_INPUTS_MINIMUM_VERSION</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.8&quot;</span><span class="p">)</span>

<span class="n">_is_offline_mode</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TRANSFORMERS_OFFLINE&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span> <span class="k">else</span> <span class="kc">False</span>


<div class="viewcode-block" id="is_offline_mode"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_offline_mode">[docs]</a><span class="k">def</span> <span class="nf">is_offline_mode</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_is_offline_mode</span></div>


<div class="viewcode-block" id="is_torch_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_torch_available</span></div>


<div class="viewcode-block" id="is_pyctcdecode_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_pyctcdecode_available">[docs]</a><span class="k">def</span> <span class="nf">is_pyctcdecode_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_pyctcdecode_available</span></div>


<div class="viewcode-block" id="is_librosa_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_librosa_available">[docs]</a><span class="k">def</span> <span class="nf">is_librosa_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_librosa_available</span></div>


<div class="viewcode-block" id="is_torch_cuda_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_cuda_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_cuda_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_torch_bf16_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_bf16_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_bf16_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="c1"># since currently no utility function is available we build our own.</span>
    <span class="c1"># some bits come from https://github.com/pytorch/pytorch/blob/2289a12f21c54da93bf5d696e3f9aea83dd9c10d/torch/testing/_internal/common_cuda.py#L51</span>
    <span class="c1"># with additional check for torch version</span>
    <span class="c1"># to succeed:</span>
    <span class="c1"># 1. the hardware needs to support bf16 (arch &gt;= Ampere)</span>
    <span class="c1"># 2. torch &gt;= 1.10 (1.9 should be enough for AMP API has changed in 1.10, so using 1.10 as minimal)</span>
    <span class="c1"># 3. CUDA &gt;= 11</span>
    <span class="c1"># 4. torch.autocast exists</span>
    <span class="c1"># XXX: one problem here is that it may give invalid results on mixed gpus setup, so it&#39;s</span>
    <span class="c1"># really only correct for the 0th gpu (or currently set default device if different from 0)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">())</span><span class="o">.</span><span class="n">major</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.10&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="s2">&quot;autocast&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="is_torch_tf32_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_tf32_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_tf32_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">())</span><span class="o">.</span><span class="n">major</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.7&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<span class="n">_torch_fx_available</span> <span class="o">=</span> <span class="n">_torch_onnx_dict_inputs_support_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">_torch_available</span><span class="p">:</span>
    <span class="n">torch_version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">))</span>
    <span class="n">_torch_fx_available</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch_version</span><span class="o">.</span><span class="n">major</span><span class="p">,</span> <span class="n">torch_version</span><span class="o">.</span><span class="n">minor</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
        <span class="n">TORCH_FX_REQUIRED_VERSION</span><span class="o">.</span><span class="n">major</span><span class="p">,</span>
        <span class="n">TORCH_FX_REQUIRED_VERSION</span><span class="o">.</span><span class="n">minor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_torch_onnx_dict_inputs_support_available</span> <span class="o">=</span> <span class="n">torch_version</span> <span class="o">&gt;=</span> <span class="n">TORCH_ONNX_DICT_INPUTS_MINIMUM_VERSION</span>


<div class="viewcode-block" id="is_torch_fx_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_fx_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_fx_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_torch_fx_available</span></div>


<div class="viewcode-block" id="is_torch_onnx_dict_inputs_support_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_onnx_dict_inputs_support_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_onnx_dict_inputs_support_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_torch_onnx_dict_inputs_support_available</span></div>


<div class="viewcode-block" id="is_tf_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_tf_available">[docs]</a><span class="k">def</span> <span class="nf">is_tf_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_tf_available</span></div>


<div class="viewcode-block" id="is_coloredlogs_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_coloredlogs_available">[docs]</a><span class="k">def</span> <span class="nf">is_coloredlogs_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_coloredlogs_available</span></div>


<div class="viewcode-block" id="is_tf2onnx_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_tf2onnx_available">[docs]</a><span class="k">def</span> <span class="nf">is_tf2onnx_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_tf2onnx_available</span></div>


<div class="viewcode-block" id="is_onnx_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_onnx_available">[docs]</a><span class="k">def</span> <span class="nf">is_onnx_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_onnx_available</span></div>


<div class="viewcode-block" id="is_flax_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_flax_available">[docs]</a><span class="k">def</span> <span class="nf">is_flax_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_flax_available</span></div>


<div class="viewcode-block" id="is_torch_tpu_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_tpu_available">[docs]</a><span class="k">def</span> <span class="nf">is_torch_tpu_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_torch_available</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># This test is probably enough, but just in case, we unpack a bit.</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_xla&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_xla.core&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_xla.core.xla_model&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_datasets_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_datasets_available">[docs]</a><span class="k">def</span> <span class="nf">is_datasets_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_datasets_available</span></div>


<div class="viewcode-block" id="is_detectron2_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_detectron2_available">[docs]</a><span class="k">def</span> <span class="nf">is_detectron2_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_detectron2_available</span></div>


<div class="viewcode-block" id="is_rjieba_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_rjieba_available">[docs]</a><span class="k">def</span> <span class="nf">is_rjieba_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;rjieba&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_psutil_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_psutil_available">[docs]</a><span class="k">def</span> <span class="nf">is_psutil_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;psutil&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_py3nvml_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_py3nvml_available">[docs]</a><span class="k">def</span> <span class="nf">is_py3nvml_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;py3nvml&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_apex_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_apex_available">[docs]</a><span class="k">def</span> <span class="nf">is_apex_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;apex&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_faiss_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_faiss_available">[docs]</a><span class="k">def</span> <span class="nf">is_faiss_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_faiss_available</span></div>


<div class="viewcode-block" id="is_scipy_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_scipy_available">[docs]</a><span class="k">def</span> <span class="nf">is_scipy_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;scipy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_sklearn_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_sklearn_available">[docs]</a><span class="k">def</span> <span class="nf">is_sklearn_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sklearn&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">is_scipy_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sklearn.metrics&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_sentencepiece_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_sentencepiece_available">[docs]</a><span class="k">def</span> <span class="nf">is_sentencepiece_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sentencepiece&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_protobuf_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_protobuf_available">[docs]</a><span class="k">def</span> <span class="nf">is_protobuf_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;google&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;google.protobuf&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_tokenizers_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_tokenizers_available">[docs]</a><span class="k">def</span> <span class="nf">is_tokenizers_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;tokenizers&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_vision_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_vision_available">[docs]</a><span class="k">def</span> <span class="nf">is_vision_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;PIL&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_pytesseract_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_pytesseract_available">[docs]</a><span class="k">def</span> <span class="nf">is_pytesseract_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pytesseract&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_spacy_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_spacy_available">[docs]</a><span class="k">def</span> <span class="nf">is_spacy_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;spacy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_ftfy_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_ftfy_available">[docs]</a><span class="k">def</span> <span class="nf">is_ftfy_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;ftfy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_in_notebook"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_in_notebook">[docs]</a><span class="k">def</span> <span class="nf">is_in_notebook</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Test adapted from tqdm.autonotebook: https://github.com/tqdm/tqdm/blob/master/tqdm/autonotebook.py</span>
        <span class="n">get_ipython</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;IPython&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ipython</span>
        <span class="k">if</span> <span class="s2">&quot;IPKernelApp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;VSCODE_PID&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;vscode&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;IPython&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_scatter_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_scatter_available">[docs]</a><span class="k">def</span> <span class="nf">is_scatter_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_scatter_available</span></div>


<div class="viewcode-block" id="is_pytorch_quantization_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_pytorch_quantization_available">[docs]</a><span class="k">def</span> <span class="nf">is_pytorch_quantization_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_pytorch_quantization_available</span></div>


<div class="viewcode-block" id="is_tensorflow_probability_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_tensorflow_probability_available">[docs]</a><span class="k">def</span> <span class="nf">is_tensorflow_probability_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_tensorflow_probability_available</span></div>


<div class="viewcode-block" id="is_pandas_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_pandas_available">[docs]</a><span class="k">def</span> <span class="nf">is_pandas_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pandas&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_sagemaker_dp_enabled"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_sagemaker_dp_enabled">[docs]</a><span class="k">def</span> <span class="nf">is_sagemaker_dp_enabled</span><span class="p">():</span>
    <span class="c1"># Get the sagemaker specific env variable.</span>
    <span class="n">sagemaker_params</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_FRAMEWORK_PARAMS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse it and check the field &quot;sagemaker_distributed_dataparallel_enabled&quot;.</span>
        <span class="n">sagemaker_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sagemaker_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sagemaker_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sagemaker_distributed_dataparallel_enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Lastly, check if the `smdistributed` module is present.</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;smdistributed&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_sagemaker_mp_enabled"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_sagemaker_mp_enabled">[docs]</a><span class="k">def</span> <span class="nf">is_sagemaker_mp_enabled</span><span class="p">():</span>
    <span class="c1"># Get the sagemaker specific mp parameters from smp_options variable.</span>
    <span class="n">smp_options</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_HP_MP_PARAMETERS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse it and check the field &quot;partitions&quot; is included, it is required for model parallel.</span>
        <span class="n">smp_options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">smp_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;partitions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">smp_options</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Get the sagemaker specific framework parameters from mpi_options variable.</span>
    <span class="n">mpi_options</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_FRAMEWORK_PARAMS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse it and check the field &quot;sagemaker_distributed_dataparallel_enabled&quot;.</span>
        <span class="n">mpi_options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mpi_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mpi_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sagemaker_mpi_enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Lastly, check if the `smdistributed` module is present.</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;smdistributed&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_training_run_on_sagemaker"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_training_run_on_sagemaker">[docs]</a><span class="k">def</span> <span class="nf">is_training_run_on_sagemaker</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;SAGEMAKER_JOB_NAME&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span></div>


<div class="viewcode-block" id="is_soundfile_availble"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_soundfile_availble">[docs]</a><span class="k">def</span> <span class="nf">is_soundfile_availble</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_soundfile_available</span></div>


<div class="viewcode-block" id="is_timm_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_timm_available">[docs]</a><span class="k">def</span> <span class="nf">is_timm_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_timm_available</span></div>


<div class="viewcode-block" id="is_torchaudio_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torchaudio_available">[docs]</a><span class="k">def</span> <span class="nf">is_torchaudio_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_torchaudio_available</span></div>


<div class="viewcode-block" id="is_speech_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_speech_available">[docs]</a><span class="k">def</span> <span class="nf">is_speech_available</span><span class="p">():</span>
    <span class="c1"># For now this depends on torchaudio but the exact dependency might evolve in the future.</span>
    <span class="k">return</span> <span class="n">_torchaudio_available</span></div>


<div class="viewcode-block" id="is_phonemizer_available"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_phonemizer_available">[docs]</a><span class="k">def</span> <span class="nf">is_phonemizer_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_phonemizer_available</span></div>


<div class="viewcode-block" id="torch_only_method"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.torch_only_method">[docs]</a><span class="k">def</span> <span class="nf">torch_only_method</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_torch_available</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;You need to install pytorch to use this method or class, &quot;</span>
                <span class="s2">&quot;or activate it with environment variables USE_TORCH=1 and USE_TF=0.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<span class="c1"># docstyle-ignore</span>
<span class="n">DATASETS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the 🤗 Datasets library but it was not found in your environment. You can install it with:</span>
<span class="s2">```</span>
<span class="s2">pip install datasets</span>
<span class="s2">```</span>
<span class="s2">In a notebook or a colab, you can install it by executing a cell with</span>
<span class="s2">```</span>
<span class="s2">!pip install datasets</span>
<span class="s2">```</span>
<span class="s2">then restarting your kernel.</span>
<span class="s2">Note that if you have a local folder named `datasets` or a local python file named `datasets.py` in your current</span>
<span class="s2">working directory, python may try to import this instead of the 🤗 Datasets library. You should rename this folder or</span>
<span class="s2">that python file if that&#39;s the case.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">TOKENIZERS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the 🤗 Tokenizers library but it was not found in your environment. You can install it with:</span>
<span class="s2">```</span>
<span class="s2">pip install tokenizers</span>
<span class="s2">```</span>
<span class="s2">In a notebook or a colab, you can install it by executing a cell with</span>
<span class="s2">```</span>
<span class="s2">!pip install tokenizers</span>
<span class="s2">```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SENTENCEPIECE_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the SentencePiece library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page of its repo: https://github.com/google/sentencepiece#installation and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PROTOBUF_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the protobuf library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page of its repo: https://github.com/protocolbuffers/protobuf/tree/master/python#installation and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">FAISS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the faiss library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page of its repo: https://github.com/facebookresearch/faiss/blob/master/INSTALL.md and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PYTORCH_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the PyTorch library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://pytorch.org/get-started/locally/ and follow the ones that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SKLEARN_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the scikit-learn library but it was not found in your environment. You can install it with:</span>
<span class="s2">```</span>
<span class="s2">pip install -U scikit-learn</span>
<span class="s2">```</span>
<span class="s2">In a notebook or a colab, you can install it by executing a cell with</span>
<span class="s2">```</span>
<span class="s2">!pip install -U scikit-learn</span>
<span class="s2">```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">TENSORFLOW_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the TensorFlow library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://www.tensorflow.org/install and follow the ones that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">DETECTRON2_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the detectron2 library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://github.com/facebookresearch/detectron2/blob/master/INSTALL.md and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">FLAX_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the FLAX library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://github.com/google/flax and follow the ones that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SCATTER_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the torch-scatter library but it was not found in your environment. You can install it with pip as</span>
<span class="s2">explained here: https://github.com/rusty1s/pytorch_scatter.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># docstyle-ignore</span>
<span class="n">PYTORCH_QUANTIZATION_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the pytorch-quantization library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install pytorch-quantization --extra-index-url https://pypi.ngc.nvidia.com`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># docstyle-ignore</span>
<span class="n">TENSORFLOW_PROBABILITY_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the tensorflow_probability library but it was not found in your environment. You can install it with pip as</span>
<span class="s2">explained here: https://github.com/tensorflow/probability.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PANDAS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the pandas library but it was not found in your environment. You can install it with pip as</span>
<span class="s2">explained here: https://pandas.pydata.org/pandas-docs/stable/getting_started/install.html.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PHONEMIZER_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the phonemizer library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install phonemizer`</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SCIPY_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the scipy library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install scipy`</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SPEECH_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the torchaudio library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install torchaudio`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># docstyle-ignore</span>
<span class="n">TIMM_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the timm library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install timm`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># docstyle-ignore</span>
<span class="n">VISION_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the PIL library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install pillow`</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PYTESSERACT_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the PyTesseract library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install pytesseract`</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># docstyle-ignore</span>
<span class="n">PYCTCDECODE_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the pyctcdecode library but it was not found in your environment. You can install it with pip:</span>
<span class="s2">`pip install pyctcdecode`</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">BACKENDS_MAPPING</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_datasets_available</span><span class="p">,</span> <span class="n">DATASETS_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;detectron2&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_detectron2_available</span><span class="p">,</span> <span class="n">DETECTRON2_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;faiss&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_faiss_available</span><span class="p">,</span> <span class="n">FAISS_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;flax&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_flax_available</span><span class="p">,</span> <span class="n">FLAX_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;pandas&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_pandas_available</span><span class="p">,</span> <span class="n">PANDAS_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;phonemizer&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_phonemizer_available</span><span class="p">,</span> <span class="n">PHONEMIZER_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;protobuf&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_protobuf_available</span><span class="p">,</span> <span class="n">PROTOBUF_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;pyctcdecode&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_pyctcdecode_available</span><span class="p">,</span> <span class="n">PYCTCDECODE_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;pytesseract&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_pytesseract_available</span><span class="p">,</span> <span class="n">PYTESSERACT_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_scatter_available</span><span class="p">,</span> <span class="n">SCATTER_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;pytorch_quantization&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_pytorch_quantization_available</span><span class="p">,</span> <span class="n">PYTORCH_QUANTIZATION_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;sentencepiece&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_sentencepiece_available</span><span class="p">,</span> <span class="n">SENTENCEPIECE_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;sklearn&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_sklearn_available</span><span class="p">,</span> <span class="n">SKLEARN_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;speech&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_speech_available</span><span class="p">,</span> <span class="n">SPEECH_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;tensorflow_probability&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_tensorflow_probability_available</span><span class="p">,</span> <span class="n">TENSORFLOW_PROBABILITY_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;tf&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_tf_available</span><span class="p">,</span> <span class="n">TENSORFLOW_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;timm&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_timm_available</span><span class="p">,</span> <span class="n">TIMM_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;tokenizers&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_tokenizers_available</span><span class="p">,</span> <span class="n">TOKENIZERS_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_torch_available</span><span class="p">,</span> <span class="n">PYTORCH_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;vision&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_vision_available</span><span class="p">,</span> <span class="n">VISION_IMPORT_ERROR</span><span class="p">)),</span>
        <span class="p">(</span><span class="s2">&quot;scipy&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">is_scipy_available</span><span class="p">,</span> <span class="n">SCIPY_IMPORT_ERROR</span><span class="p">)),</span>
    <span class="p">]</span>
<span class="p">)</span>


<div class="viewcode-block" id="requires_backends"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.requires_backends">[docs]</a><span class="k">def</span> <span class="nf">requires_backends</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">backends</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">backends</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">backends</span><span class="p">]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">BACKENDS_MAPPING</span><span class="p">[</span><span class="n">backend</span><span class="p">][</span><span class="mi">0</span><span class="p">]()</span> <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">backends</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">BACKENDS_MAPPING</span><span class="p">[</span><span class="n">backend</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">backends</span><span class="p">]))</span></div>


<div class="viewcode-block" id="DummyObject"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.DummyObject">[docs]</a><span class="k">class</span> <span class="nc">DummyObject</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass for the dummy objects. Any class inheriting from it will return the ImportError generated by</span>
<span class="sd">    `requires_backend` each time a user tries to access any method of that class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">requires_backends</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_backends</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_start_docstrings"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.add_start_docstrings">[docs]</a><span class="k">def</span> <span class="nf">add_start_docstrings</span><span class="p">(</span><span class="o">*</span><span class="n">docstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span></div>


<div class="viewcode-block" id="add_start_docstrings_to_model_forward"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.add_start_docstrings_to_model_forward">[docs]</a><span class="k">def</span> <span class="nf">add_start_docstrings_to_model_forward</span><span class="p">(</span><span class="o">*</span><span class="n">docstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[`</span><span class="si">{</span><span class="n">fn</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">`]&quot;</span>
        <span class="n">intro</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;   The </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2"> forward method, overrides the `__call__` special method.&quot;</span>
        <span class="n">note</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;Tip&gt;</span>
<span class="s2">    Although the recipe for forward pass needs to be defined within this function, one should call the [`Module`]</span>
<span class="s2">    instance afterwards instead of this since the former takes care of running the pre and post processing steps while</span>
<span class="s2">    the latter silently ignores them.</span>
<span class="s2">    &lt;/Tip&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">note</span> <span class="o">+</span> <span class="n">docstring</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span></div>


<div class="viewcode-block" id="add_end_docstrings"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.add_end_docstrings">[docs]</a><span class="k">def</span> <span class="nf">add_end_docstrings</span><span class="p">(</span><span class="o">*</span><span class="n">docstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span></div>


<span class="n">PT_RETURN_INTRODUCTION</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Returns:</span>
<span class="s2">        [`</span><span class="si">{full_output_type}</span><span class="s2">`] or `tuple(torch.FloatTensor)`: A [`</span><span class="si">{full_output_type}</span><span class="s2">`] or a tuple of</span>
<span class="s2">        `torch.FloatTensor` (if `return_dict=False` is passed or when `config.return_dict=False`) comprising various</span>
<span class="s2">        elements depending on the configuration ([`</span><span class="si">{config_class}</span><span class="s2">`]) and inputs.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">TF_RETURN_INTRODUCTION</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Returns:</span>
<span class="s2">        [`</span><span class="si">{full_output_type}</span><span class="s2">`] or `tuple(tf.Tensor)`: A [`</span><span class="si">{full_output_type}</span><span class="s2">`] or a tuple of `tf.Tensor` (if</span>
<span class="s2">        `return_dict=False` is passed or when `config.return_dict=False`) comprising various elements depending on the</span>
<span class="s2">        configuration ([`</span><span class="si">{config_class}</span><span class="s2">`]) and inputs.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_get_indent</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the indentation in the first line of t&quot;&quot;&quot;</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\s*)\S&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">search</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">search</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_convert_output_args_doc</span><span class="p">(</span><span class="n">output_args_doc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert output_args_doc to display properly.&quot;&quot;&quot;</span>
    <span class="c1"># Split output_arg_doc in blocks argument/description</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="n">_get_indent</span><span class="p">(</span><span class="n">output_args_doc</span><span class="p">)</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output_args_doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="c1"># If the indent is the same as the beginning, the line is the name of new arg.</span>
        <span class="k">if</span> <span class="n">_get_indent</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="n">indent</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_block</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">current_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise it&#39;s part of the description of the current arg.</span>
            <span class="c1"># We need to remove 2 spaces to the indentation.</span>
            <span class="n">current_block</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_block</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Format each block for proper rendering</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)):</span>
        <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\s+)(\S+)(\s+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1- **\2**\3&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;:\s*\n\s*(\S)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot; -- \1&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_prepare_output_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="p">,</span> <span class="n">min_indent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the return part of the docstring using `output_type`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_docstring</span> <span class="o">=</span> <span class="n">output_type</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="c1"># Remove the head of the docstring to keep the list of args only</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">output_docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(Args|Parameters):\s*$&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">params_docstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:])</span>
        <span class="n">params_docstring</span> <span class="o">=</span> <span class="n">_convert_output_args_doc</span><span class="p">(</span><span class="n">params_docstring</span><span class="p">)</span>

    <span class="c1"># Add the return introduction</span>
    <span class="n">full_output_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">output_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">intro</span> <span class="o">=</span> <span class="n">TF_RETURN_INTRODUCTION</span> <span class="k">if</span> <span class="n">output_type</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">PT_RETURN_INTRODUCTION</span>
    <span class="n">intro</span> <span class="o">=</span> <span class="n">intro</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_output_type</span><span class="o">=</span><span class="n">full_output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="o">=</span><span class="n">config_class</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">params_docstring</span>

    <span class="c1"># Apply minimum indent if necessary</span>
    <span class="k">if</span> <span class="n">min_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Find the indent of the first nonempty line</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_get_indent</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c1"># If too small, add indentation to all nonempty lines</span>
        <span class="k">if</span> <span class="n">indent</span> <span class="o">&lt;</span> <span class="n">min_indent</span><span class="p">:</span>
            <span class="n">to_add</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">min_indent</span> <span class="o">-</span> <span class="n">indent</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">to_add</span><span class="si">}{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="n">PT_TOKEN_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; labels = torch.tensor([1] * inputs[&quot;input_ids&quot;].size(1)).unsqueeze(0)  # Batch size 1</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_QUESTION_ANSWERING_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; question, text = &quot;Who was Jim Henson?&quot;, &quot;Jim Henson was a nice puppet&quot;</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(question, text, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; start_positions = torch.tensor([1])</span>
<span class="s2">    &gt;&gt;&gt; end_positions = torch.tensor([3])</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs, start_positions=start_positions, end_positions=end_positions)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; start_scores = outputs.start_logits</span>
<span class="s2">    &gt;&gt;&gt; end_scores = outputs.end_logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_SEQUENCE_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example of single-label classification:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; labels = torch.tensor([1]).unsqueeze(0)  # Batch size 1</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">    Example of multi-label classification:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;, problem_type=&quot;multi_label_classification&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; labels = torch.tensor([[1, 1]], dtype=torch.float)  # need dtype=float for BCEWithLogitsLoss</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">PT_MASKED_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;The capital of France is </span><span class="si">{mask}</span><span class="s2">.&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; labels = tokenizer(&quot;The capital of France is Paris.&quot;, return_tensors=&quot;pt&quot;)[&quot;input_ids&quot;]</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_BASE_MODEL_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; last_hidden_states = outputs.last_hidden_state</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_MULTIPLE_CHOICE_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; prompt = &quot;In Italy, pizza served in formal settings, such as at a restaurant, is presented unsliced.&quot;</span>
<span class="s2">    &gt;&gt;&gt; choice0 = &quot;It is eaten with a fork and a knife.&quot;</span>
<span class="s2">    &gt;&gt;&gt; choice1 = &quot;It is eaten while held in the hand.&quot;</span>
<span class="s2">    &gt;&gt;&gt; labels = torch.tensor(0).unsqueeze(0)  # choice0 is correct (according to Wikipedia ;)), batch size 1</span>
<span class="s2">    &gt;&gt;&gt; encoding = tokenizer([prompt, prompt], [choice0, choice1], return_tensors=&quot;pt&quot;, padding=True)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**{{k: v.unsqueeze(0) for k, v in encoding.items()}}, labels=labels)  # batch size is 1</span>
<span class="s2">    &gt;&gt;&gt; # the linear classifier still needs to be trained</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_CAUSAL_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs, labels=inputs[&quot;input_ids&quot;])</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_SPEECH_BASE_MODEL_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="s2">    &gt;&gt;&gt; dataset = load_dataset(&quot;hf-internal-testing/librispeech_asr_demo&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
<span class="s2">    &gt;&gt;&gt; dataset = dataset.sort(&quot;id&quot;)</span>
<span class="s2">    &gt;&gt;&gt; sampling_rate = dataset.features[&quot;audio&quot;].sampling_rate</span>
<span class="s2">    &gt;&gt;&gt; processor = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; # audio file is decoded on the fly</span>
<span class="s2">    &gt;&gt;&gt; inputs = processor(dataset[0][&quot;audio&quot;][&quot;array&quot;], sampling_rate=sampling_rate, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; with torch.no_grad():</span>
<span class="s2">    ...     outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; last_hidden_states = outputs.last_hidden_state</span>
<span class="s2">    &gt;&gt;&gt; list(last_hidden_states.shape)</span>
<span class="s2">    </span><span class="si">{expected_output}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_SPEECH_CTC_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; dataset = load_dataset(&quot;hf-internal-testing/librispeech_asr_demo&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
<span class="s2">    &gt;&gt;&gt; dataset = dataset.sort(&quot;id&quot;)</span>
<span class="s2">    &gt;&gt;&gt; sampling_rate = dataset.features[&quot;audio&quot;].sampling_rate</span>
<span class="s2">    &gt;&gt;&gt; processor = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; # audio file is decoded on the fly</span>
<span class="s2">    &gt;&gt;&gt; inputs = processor(dataset[0][&quot;audio&quot;][&quot;array&quot;], sampling_rate=sampling_rate, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; with torch.no_grad():</span>
<span class="s2">    ...     logits = model(**inputs).logits</span>
<span class="s2">    &gt;&gt;&gt; predicted_ids = torch.argmax(logits, dim=-1)</span>
<span class="s2">    &gt;&gt;&gt; # transcribe speech</span>
<span class="s2">    &gt;&gt;&gt; transcription = processor.batch_decode(predicted_ids)</span>
<span class="s2">    &gt;&gt;&gt; transcription[0]</span>
<span class="s2">    </span><span class="si">{expected_output}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; with processor.as_target_processor():</span>
<span class="s2">    ...     inputs[&quot;labels&quot;] = processor(dataset[0][&quot;text&quot;], return_tensors=&quot;pt&quot;).input_ids</span>
<span class="s2">    &gt;&gt;&gt; # compute loss</span>
<span class="s2">    &gt;&gt;&gt; loss = model(**inputs).loss</span>
<span class="s2">    &gt;&gt;&gt; round(loss.item(), 2)</span>
<span class="s2">    </span><span class="si">{expected_loss}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_SPEECH_SEQ_CLASS_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; dataset = load_dataset(&quot;hf-internal-testing/librispeech_asr_demo&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
<span class="s2">    &gt;&gt;&gt; dataset = dataset.sort(&quot;id&quot;)</span>
<span class="s2">    &gt;&gt;&gt; sampling_rate = dataset.features[&quot;audio&quot;].sampling_rate</span>
<span class="s2">    &gt;&gt;&gt; feature_extractor = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; # audio file is decoded on the fly</span>
<span class="s2">    &gt;&gt;&gt; inputs = feature_extractor(dataset[0][&quot;audio&quot;][&quot;array&quot;], sampling_rate=sampling_rate, return_tensors=&quot;pt&quot;)</span>
<span class="s2">    &gt;&gt;&gt; with torch.no_grad():</span>
<span class="s2">    ...     logits = model(**inputs).logits</span>
<span class="s2">    &gt;&gt;&gt; predicted_class_ids = torch.argmax(logits, dim=-1).item()</span>
<span class="s2">    &gt;&gt;&gt; predicted_label = model.config.id2label[predicted_class_ids]</span>
<span class="s2">    &gt;&gt;&gt; predicted_label</span>
<span class="s2">    </span><span class="si">{expected_output}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; # compute loss - target_label is e.g. &quot;down&quot;</span>
<span class="s2">    &gt;&gt;&gt; target_label = model.config.id2label[0]</span>
<span class="s2">    &gt;&gt;&gt; inputs[&quot;labels&quot;] = torch.tensor([model.config.label2id[target_label]])</span>
<span class="s2">    &gt;&gt;&gt; loss = model(**inputs).loss</span>
<span class="s2">    &gt;&gt;&gt; round(loss.item(), 2)</span>
<span class="s2">    </span><span class="si">{expected_loss}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">PT_SPEECH_FRAME_CLASS_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; dataset = load_dataset(&quot;hf-internal-testing/librispeech_asr_demo&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
<span class="s2">    &gt;&gt;&gt; dataset = dataset.sort(&quot;id&quot;)</span>
<span class="s2">    &gt;&gt;&gt; sampling_rate = dataset.features[&quot;audio&quot;].sampling_rate</span>
<span class="s2">    &gt;&gt;&gt; feature_extractor = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; # audio file is decoded on the fly</span>
<span class="s2">    &gt;&gt;&gt; inputs = feature_extractor(dataset[0][&quot;audio&quot;][&quot;array&quot;], return_tensors=&quot;pt&quot;, sampling_rate=sampling_rate)</span>
<span class="s2">    &gt;&gt;&gt; with torch.no_grad():</span>
<span class="s2">    ...     logits = model(**inputs).logits</span>
<span class="s2">    &gt;&gt;&gt; probabilities = torch.sigmoid(logits[0])</span>
<span class="s2">    &gt;&gt;&gt; # labels is a one-hot array of shape (num_frames, num_speakers)</span>
<span class="s2">    &gt;&gt;&gt; labels = (probabilities &gt; 0.5).long()</span>
<span class="s2">    &gt;&gt;&gt; labels[0].tolist()</span>
<span class="s2">    </span><span class="si">{expected_output}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">PT_SPEECH_XVECTOR_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; from datasets import load_dataset</span>
<span class="s2">    &gt;&gt;&gt; import torch</span>
<span class="s2">    &gt;&gt;&gt; dataset = load_dataset(&quot;hf-internal-testing/librispeech_asr_demo&quot;, &quot;clean&quot;, split=&quot;validation&quot;)</span>
<span class="s2">    &gt;&gt;&gt; dataset = dataset.sort(&quot;id&quot;)</span>
<span class="s2">    &gt;&gt;&gt; sampling_rate = dataset.features[&quot;audio&quot;].sampling_rate</span>
<span class="s2">    &gt;&gt;&gt; feature_extractor = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; # audio file is decoded on the fly</span>
<span class="s2">    &gt;&gt;&gt; inputs = feature_extractor(</span>
<span class="s2">    ...     [d[&quot;array&quot;] for d in dataset[:2][&quot;audio&quot;]], sampling_rate=sampling_rate, return_tensors=&quot;pt&quot;, padding=True</span>
<span class="s2">    ... )</span>
<span class="s2">    &gt;&gt;&gt; with torch.no_grad():</span>
<span class="s2">    ...     embeddings = model(**inputs).embeddings</span>
<span class="s2">    &gt;&gt;&gt; embeddings = torch.nn.functional.normalize(embeddings, dim=-1).cpu()</span>
<span class="s2">    &gt;&gt;&gt; # the resulting embeddings can be used for cosine similarity-based retrieval</span>
<span class="s2">    &gt;&gt;&gt; cosine_sim = torch.nn.CosineSimilarity(dim=-1)</span>
<span class="s2">    &gt;&gt;&gt; similarity = cosine_sim(embeddings[0], embeddings[1])</span>
<span class="s2">    &gt;&gt;&gt; threshold = 0.7  # the optimal threshold is dataset-dependent</span>
<span class="s2">    &gt;&gt;&gt; if similarity &lt; threshold:</span>
<span class="s2">    ...     print(&quot;Speakers are not the same!&quot;)</span>
<span class="s2">    &gt;&gt;&gt; round(similarity.item(), 2)</span>
<span class="s2">    </span><span class="si">{expected_output}</span><span class="s2"></span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_SAMPLE_DOCSTRINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SequenceClassification&quot;</span><span class="p">:</span> <span class="n">PT_SEQUENCE_CLASSIFICATION_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;QuestionAnswering&quot;</span><span class="p">:</span> <span class="n">PT_QUESTION_ANSWERING_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;TokenClassification&quot;</span><span class="p">:</span> <span class="n">PT_TOKEN_CLASSIFICATION_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;MultipleChoice&quot;</span><span class="p">:</span> <span class="n">PT_MULTIPLE_CHOICE_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;MaskedLM&quot;</span><span class="p">:</span> <span class="n">PT_MASKED_LM_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;LMHead&quot;</span><span class="p">:</span> <span class="n">PT_CAUSAL_LM_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span> <span class="n">PT_BASE_MODEL_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;SpeechBaseModel&quot;</span><span class="p">:</span> <span class="n">PT_SPEECH_BASE_MODEL_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;CTC&quot;</span><span class="p">:</span> <span class="n">PT_SPEECH_CTC_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;AudioClassification&quot;</span><span class="p">:</span> <span class="n">PT_SPEECH_SEQ_CLASS_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;AudioFrameClassification&quot;</span><span class="p">:</span> <span class="n">PT_SPEECH_FRAME_CLASS_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;AudioXVector&quot;</span><span class="p">:</span> <span class="n">PT_SPEECH_XVECTOR_SAMPLE</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">TF_TOKEN_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">    &gt;&gt;&gt; input_ids = inputs[&quot;input_ids&quot;]</span>
<span class="s2">    &gt;&gt;&gt; inputs[&quot;labels&quot;] = tf.reshape(</span>
<span class="s2">    ...     tf.constant([1] * tf.size(input_ids).numpy()), (-1, tf.size(input_ids))</span>
<span class="s2">    &gt;&gt;&gt; )  # Batch size 1</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_QUESTION_ANSWERING_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; question, text = &quot;Who was Jim Henson?&quot;, &quot;Jim Henson was a nice puppet&quot;</span>
<span class="s2">    &gt;&gt;&gt; input_dict = tokenizer(question, text, return_tensors=&quot;tf&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(input_dict)</span>
<span class="s2">    &gt;&gt;&gt; start_logits = outputs.start_logits</span>
<span class="s2">    &gt;&gt;&gt; end_logits = outputs.end_logits</span>
<span class="s2">    &gt;&gt;&gt; all_tokens = tokenizer.convert_ids_to_tokens(input_dict[&quot;input_ids&quot;].numpy()[0])</span>
<span class="s2">    &gt;&gt;&gt; answer = &quot; &quot;.join(all_tokens[tf.math.argmax(start_logits, 1)[0] : tf.math.argmax(end_logits, 1)[0] + 1])</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_SEQUENCE_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs[&quot;labels&quot;] = tf.reshape(tf.constant(1), (-1, 1))  # Batch size 1</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_MASKED_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;The capital of France is </span><span class="si">{mask}</span><span class="s2">.&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs[&quot;labels&quot;] = tokenizer(&quot;The capital of France is Paris.&quot;, return_tensors=&quot;tf&quot;)[&quot;input_ids&quot;]</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">    &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_BASE_MODEL_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">    &gt;&gt;&gt; last_hidden_states = outputs.last_hidden_state</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_MULTIPLE_CHOICE_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; prompt = &quot;In Italy, pizza served in formal settings, such as at a restaurant, is presented unsliced.&quot;</span>
<span class="s2">    &gt;&gt;&gt; choice0 = &quot;It is eaten with a fork and a knife.&quot;</span>
<span class="s2">    &gt;&gt;&gt; choice1 = &quot;It is eaten while held in the hand.&quot;</span>
<span class="s2">    &gt;&gt;&gt; encoding = tokenizer([prompt, prompt], [choice0, choice1], return_tensors=&quot;tf&quot;, padding=True)</span>
<span class="s2">    &gt;&gt;&gt; inputs = {{k: tf.expand_dims(v, 0) for k, v in encoding.items()}}</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(inputs)  # batch size is 1</span>
<span class="s2">    &gt;&gt;&gt; # the linear classifier still needs to be trained</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_CAUSAL_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; import tensorflow as tf</span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_SAMPLE_DOCSTRINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SequenceClassification&quot;</span><span class="p">:</span> <span class="n">TF_SEQUENCE_CLASSIFICATION_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;QuestionAnswering&quot;</span><span class="p">:</span> <span class="n">TF_QUESTION_ANSWERING_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;TokenClassification&quot;</span><span class="p">:</span> <span class="n">TF_TOKEN_CLASSIFICATION_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;MultipleChoice&quot;</span><span class="p">:</span> <span class="n">TF_MULTIPLE_CHOICE_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;MaskedLM&quot;</span><span class="p">:</span> <span class="n">TF_MASKED_LM_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;LMHead&quot;</span><span class="p">:</span> <span class="n">TF_CAUSAL_LM_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span> <span class="n">TF_BASE_MODEL_SAMPLE</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">FLAX_TOKEN_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;jax&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_QUESTION_ANSWERING_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; question, text = &quot;Who was Jim Henson?&quot;, &quot;Jim Henson was a nice puppet&quot;</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(question, text, return_tensors=&quot;jax&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; start_scores = outputs.start_logits</span>
<span class="s2">    &gt;&gt;&gt; end_scores = outputs.end_logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_SEQUENCE_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;jax&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_MASKED_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;The capital of France is </span><span class="si">{mask}</span><span class="s2">.&quot;, return_tensors=&quot;jax&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_BASE_MODEL_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;jax&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; last_hidden_states = outputs.last_hidden_state</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_MULTIPLE_CHOICE_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; prompt = &quot;In Italy, pizza served in formal settings, such as at a restaurant, is presented unsliced.&quot;</span>
<span class="s2">    &gt;&gt;&gt; choice0 = &quot;It is eaten with a fork and a knife.&quot;</span>
<span class="s2">    &gt;&gt;&gt; choice1 = &quot;It is eaten while held in the hand.&quot;</span>
<span class="s2">    &gt;&gt;&gt; encoding = tokenizer([prompt, prompt], [choice0, choice1], return_tensors=&quot;jax&quot;, padding=True)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**{{k: v[None, :] for k, v in encoding.items()}})</span>
<span class="s2">    &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_CAUSAL_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example:</span>
<span class="s2">    ```python</span>
<span class="s2">    &gt;&gt;&gt; from transformers import </span><span class="si">{processor_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">    &gt;&gt;&gt; tokenizer = </span><span class="si">{processor_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&quot;</span><span class="si">{checkpoint}</span><span class="s2">&quot;)</span>
<span class="s2">    &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;np&quot;)</span>
<span class="s2">    &gt;&gt;&gt; outputs = model(**inputs)</span>
<span class="s2">    &gt;&gt;&gt; # retrieve logts for next token</span>
<span class="s2">    &gt;&gt;&gt; next_token_logits = outputs.logits[:, -1]</span>
<span class="s2">    ```</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">FLAX_SAMPLE_DOCSTRINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;SequenceClassification&quot;</span><span class="p">:</span> <span class="n">FLAX_SEQUENCE_CLASSIFICATION_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;QuestionAnswering&quot;</span><span class="p">:</span> <span class="n">FLAX_QUESTION_ANSWERING_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;TokenClassification&quot;</span><span class="p">:</span> <span class="n">FLAX_TOKEN_CLASSIFICATION_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;MultipleChoice&quot;</span><span class="p">:</span> <span class="n">FLAX_MULTIPLE_CHOICE_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;MaskedLM&quot;</span><span class="p">:</span> <span class="n">FLAX_MASKED_LM_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span> <span class="n">FLAX_BASE_MODEL_SAMPLE</span><span class="p">,</span>
    <span class="s2">&quot;LMHead&quot;</span><span class="p">:</span> <span class="n">FLAX_CAUSAL_LM_SAMPLE</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="add_code_sample_docstrings"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.add_code_sample_docstrings">[docs]</a><span class="k">def</span> <span class="nf">add_code_sample_docstrings</span><span class="p">(</span>
    <span class="o">*</span><span class="n">docstr</span><span class="p">,</span>
    <span class="n">processor_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">config_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;[MASK]&quot;</span><span class="p">,</span>
    <span class="n">model_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">modality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">expected_output</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">expected_loss</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="c1"># model_class defaults to function&#39;s class if not specified otherwise</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">model_cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">model_cls</span>

        <span class="k">if</span> <span class="n">model_class</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TF&quot;</span><span class="p">:</span>
            <span class="n">sample_docstrings</span> <span class="o">=</span> <span class="n">TF_SAMPLE_DOCSTRINGS</span>
        <span class="k">elif</span> <span class="n">model_class</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Flax&quot;</span><span class="p">:</span>
            <span class="n">sample_docstrings</span> <span class="o">=</span> <span class="n">FLAX_SAMPLE_DOCSTRINGS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample_docstrings</span> <span class="o">=</span> <span class="n">PT_SAMPLE_DOCSTRINGS</span>

        <span class="c1"># putting all kwargs for docstrings in a dict to be used</span>
        <span class="c1"># with the `.format(**doc_kwargs)`. Note that string might</span>
        <span class="c1"># be formatted with non-existing keys, which is fine.</span>
        <span class="n">doc_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">model_class</span><span class="o">=</span><span class="n">model_class</span><span class="p">,</span>
            <span class="n">processor_class</span><span class="o">=</span><span class="n">processor_class</span><span class="p">,</span>
            <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">expected_output</span><span class="o">=</span><span class="n">expected_output</span><span class="p">,</span>
            <span class="n">expected_loss</span><span class="o">=</span><span class="n">expected_loss</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;SequenceClassification&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">and</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;AudioClassification&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;SequenceClassification&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;SequenceClassification&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;QuestionAnswering&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;QuestionAnswering&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;TokenClassification&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;TokenClassification&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;MultipleChoice&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;MultipleChoice&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;MaskedLM&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="n">model_class</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FlaubertWithLMHeadModel&quot;</span><span class="p">,</span> <span class="s2">&quot;XLMWithLMHeadModel&quot;</span><span class="p">]:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;MaskedLM&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;LMHead&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="s2">&quot;CausalLM&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;LMHead&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;CTC&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;CTC&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;AudioFrameClassification&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;AudioFrameClassification&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;XVector&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">and</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;AudioXVector&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;Model&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">and</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;SpeechBaseModel&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;Model&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="s2">&quot;Encoder&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">sample_docstrings</span><span class="p">[</span><span class="s2">&quot;BaseModel&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Docstring can&#39;t be built for model </span><span class="si">{</span><span class="n">model_class</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">func_doc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="n">output_doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">output_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_prepare_output_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="p">)</span>
        <span class="n">built_doc</span> <span class="o">=</span> <span class="n">code_sample</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">doc_kwargs</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func_doc</span> <span class="o">+</span> <span class="n">output_doc</span> <span class="o">+</span> <span class="n">built_doc</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span></div>


<div class="viewcode-block" id="replace_return_docstrings"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.replace_return_docstrings">[docs]</a><span class="k">def</span> <span class="nf">replace_return_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">func_doc</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">func_doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*Returns?:\s*$&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_get_indent</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_prepare_output_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="p">,</span> <span class="n">min_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">func_doc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The function </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> should have an empty &#39;Return:&#39; or &#39;Returns:&#39; in its docstring as placeholder, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;current docstring is:</span><span class="se">\n</span><span class="si">{</span><span class="n">func_doc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func_doc</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span></div>


<div class="viewcode-block" id="is_remote_url"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_remote_url">[docs]</a><span class="k">def</span> <span class="nf">is_remote_url</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">):</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="hf_bucket_url"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.hf_bucket_url">[docs]</a><span class="k">def</span> <span class="nf">hf_bucket_url</span><span class="p">(</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mirror</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve a model identifier, a file name, and an optional revision id, to a huggingface.co-hosted url, redirecting</span>
<span class="sd">    to Cloudfront (a Content Delivery Network, or CDN) for large files.</span>
<span class="sd">    Cloudfront is replicated over the globe so downloads are way faster for the end user (and it also lowers our</span>
<span class="sd">    bandwidth costs).</span>
<span class="sd">    Cloudfront aggressively caches files by default (default TTL is 24 hours), however this is not an issue here</span>
<span class="sd">    because we migrated to a git-based versioning system on huggingface.co, so we now store the files on S3/Cloudfront</span>
<span class="sd">    in a content-addressable way (i.e., the file name is its hash). Using content-addressable filenames means cache</span>
<span class="sd">    can&#39;t ever be stale.</span>
<span class="sd">    In terms of client-side caching from this library, we base our caching on the objects&#39; ETag. An object&#39; ETag is:</span>
<span class="sd">    its sha1 if stored in git, or its sha256 if stored in git-lfs. Files cached locally from transformers before v3.5.0</span>
<span class="sd">    are not shared with those new files, because the cached file&#39;s name contains a hash of the url (which changed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subfolder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfolder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">mirror</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mirror</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tuna&quot;</span><span class="p">,</span> <span class="s2">&quot;bfsu&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The Tuna and BFSU mirrors are no longer available. Try removing the mirror argument.&quot;</span><span class="p">)</span>
        <span class="n">legacy_format</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_id</span>
        <span class="k">if</span> <span class="n">legacy_format</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mirror</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mirror</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">revision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span>
    <span class="k">return</span> <span class="n">HUGGINGFACE_CO_PREFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="url_to_filename"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.url_to_filename">[docs]</a><span class="k">def</span> <span class="nf">url_to_filename</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">etag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert `url` into a hashed filename in a repeatable way. If `etag` is specified, append its hash to the url&#39;s,</span>
<span class="sd">    delimited by a period. If the url ends with .h5 (Keras HDF5 weights) adds &#39;.h5&#39; to the name so that TF 2.0 can</span>
<span class="sd">    identify it as a HDF5 file (see</span>
<span class="sd">    https://github.com/tensorflow/tensorflow/blob/00fad90125b18b80fe054de1055770cfb8fe4ba3/tensorflow/python/keras/engine/network.py#L1380)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url_bytes</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">url_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">etag</span><span class="p">:</span>
        <span class="n">etag_bytes</span> <span class="o">=</span> <span class="n">etag</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">sha256</span><span class="p">(</span><span class="n">etag_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.h5&quot;</span>

    <span class="k">return</span> <span class="n">filename</span></div>


<div class="viewcode-block" id="filename_to_url"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.filename_to_url">[docs]</a><span class="k">def</span> <span class="nf">filename_to_url</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the url and etag (which may be `None`) stored for *filename*. Raise `EnvironmentError` if *filename* or its</span>
<span class="sd">    stored metadata do not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="n">meta_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meta_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file </span><span class="si">{</span><span class="n">meta_path</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span></div>


<div class="viewcode-block" id="get_cached_models"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.get_cached_models">[docs]</a><span class="k">def</span> <span class="nf">get_cached_models</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of tuples representing model binaries that are cached locally. Each tuple has shape `(model_url,</span>
<span class="sd">    etag, size_MB)`. Filenames in `cache_dir` are use to get the metadata for each model, only urls ending with *.bin*</span>
<span class="sd">    are added.</span>
<span class="sd">    Args:</span>
<span class="sd">        cache_dir (`Union[str, Path]`, *optional*):</span>
<span class="sd">            The cache directory to search for models within. Will default to the transformers cache if unset.</span>
<span class="sd">    Returns:</span>
<span class="sd">        List[Tuple]: List of tuples each with shape `(model_url, etag, size_MB)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="n">cached_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                <span class="n">etag</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.bin&quot;</span><span class="p">):</span>
                    <span class="n">size_MB</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">meta_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e6</span>
                    <span class="n">cached_models</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">,</span> <span class="n">size_MB</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cached_models</span></div>


<div class="viewcode-block" id="cached_path"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.cached_path">[docs]</a><span class="k">def</span> <span class="nf">cached_path</span><span class="p">(</span>
    <span class="n">url_or_filename</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resume_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extract_compressed_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">force_extract</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given something that might be a URL (or might be a local path), determine which. If it&#39;s a URL, download the file</span>
<span class="sd">    and cache it, and return the path to the cached file. If it&#39;s already a local path, make sure the file exists and</span>
<span class="sd">    then return the path</span>
<span class="sd">    Args:</span>
<span class="sd">        cache_dir: specify a cache directory to save the file to (overwrite the default cache dir).</span>
<span class="sd">        force_download: if True, re-download the file even if it&#39;s already cached in the cache dir.</span>
<span class="sd">        resume_download: if True, resume the download if incompletely received file is found.</span>
<span class="sd">        user_agent: Optional string or dict that will be appended to the user-agent on remote requests.</span>
<span class="sd">        use_auth_token: Optional string or boolean to use as Bearer token for remote files. If True,</span>
<span class="sd">            will get token from ~/.huggingface.</span>
<span class="sd">        extract_compressed_file: if True and the path point to a zip or tar file, extract the compressed</span>
<span class="sd">            file in a folder along the archive.</span>
<span class="sd">        force_extract: if True when extract_compressed_file is True and the archive was already extracted,</span>
<span class="sd">            re-extract the archive and override the folder where it was extracted.</span>
<span class="sd">    Return:</span>
<span class="sd">        Local path (string) of file or if networking is off, last version of file cached on disk.</span>
<span class="sd">    Raises:</span>
<span class="sd">        In case of non-recoverable file (non-existent or inaccessible url + no cache on disk).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">url_or_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_offline_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local_files_only</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Offline mode: forcing local_files_only=True&quot;</span><span class="p">)</span>
        <span class="n">local_files_only</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">):</span>
        <span class="c1"># URL, so get it from the cache (downloading if necessary)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">get_from_cache</span><span class="p">(</span>
            <span class="n">url_or_filename</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
            <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
            <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
            <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span><span class="p">,</span>
            <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">):</span>
        <span class="c1"># File, and it exists.</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">url_or_filename</span>
    <span class="k">elif</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="c1"># File, but it doesn&#39;t exist.</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file </span><span class="si">{</span><span class="n">url_or_filename</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Something unknown</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unable to parse </span><span class="si">{</span><span class="n">url_or_filename</span><span class="si">}</span><span class="s2"> as a URL or as a local path&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extract_compressed_file</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_zipfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output_path</span>

        <span class="c1"># Path where we extract compressed archives</span>
        <span class="c1"># We avoid &#39;.&#39; in dir name and add &quot;-extracted&quot; at the end: &quot;./model.zip&quot; =&gt; &quot;./model-zip-extracted/&quot;</span>
        <span class="n">output_dir</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">output_extract_dir_name</span> <span class="o">=</span> <span class="n">output_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-extracted&quot;</span>
        <span class="n">output_path_extracted</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_extract_dir_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_extract</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_path_extracted</span>

        <span class="c1"># Prevent parallel extractions</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_zipfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_file</span><span class="p">:</span>
                    <span class="n">zip_file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span>
                    <span class="n">zip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="n">tar_file</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="n">tar_file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span>
                <span class="n">tar_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archive format of </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> could not be identified&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output_path_extracted</span>

    <span class="k">return</span> <span class="n">output_path</span></div>


<div class="viewcode-block" id="define_sagemaker_information"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.define_sagemaker_information">[docs]</a><span class="k">def</span> <span class="nf">define_sagemaker_information</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ECS_CONTAINER_METADATA_URI&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">dlc_container_used</span> <span class="o">=</span> <span class="n">instance_data</span><span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span>
        <span class="n">dlc_tag</span> <span class="o">=</span> <span class="n">instance_data</span><span class="p">[</span><span class="s2">&quot;Image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">dlc_container_used</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dlc_tag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">sagemaker_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_FRAMEWORK_PARAMS&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="n">runs_distributed_training</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;sagemaker_distributed_dataparallel_enabled&quot;</span> <span class="ow">in</span> <span class="n">sagemaker_params</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TRAINING_JOB_ARN&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;TRAINING_JOB_ARN&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">sagemaker_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;sm_framework&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_FRAMEWORK_MODULE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;sm_region&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AWS_REGION&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;sm_number_gpu&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_NUM_GPUS&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;sm_number_cpu&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SM_NUM_CPUS&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;sm_distributed_training&quot;</span><span class="p">:</span> <span class="n">runs_distributed_training</span><span class="p">,</span>
        <span class="s2">&quot;sm_deep_learning_container&quot;</span><span class="p">:</span> <span class="n">dlc_container_used</span><span class="p">,</span>
        <span class="s2">&quot;sm_deep_learning_container_tag&quot;</span><span class="p">:</span> <span class="n">dlc_tag</span><span class="p">,</span>
        <span class="s2">&quot;sm_account_id&quot;</span><span class="p">:</span> <span class="n">account_id</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sagemaker_object</span></div>


<div class="viewcode-block" id="http_user_agent"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.http_user_agent">[docs]</a><span class="k">def</span> <span class="nf">http_user_agent</span><span class="p">(</span><span class="n">user_agent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats a user-agent string with basic info about a request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;transformers/</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">; python/</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">; session_id/</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; torch/</span><span class="si">{</span><span class="n">_torch_version</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">is_tf_available</span><span class="p">():</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; tensorflow/</span><span class="si">{</span><span class="n">_tf_version</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">DISABLE_TELEMETRY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ua</span> <span class="o">+</span> <span class="s2">&quot;; telemetry/off&quot;</span>
    <span class="k">if</span> <span class="n">is_training_run_on_sagemaker</span><span class="p">():</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">define_sagemaker_information</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="c1"># CI will set this value to True</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TRANSFORMERS_IS_CI&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="p">:</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="s2">&quot;; is_ci/true&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_agent</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_agent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="n">user_agent</span>
    <span class="k">return</span> <span class="n">ua</span></div>


<div class="viewcode-block" id="RepositoryNotFoundError"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.RepositoryNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">RepositoryNotFoundError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised when trying to access a hf.co URL with an invalid repository name, or with a private repo name the user does</span>
<span class="sd">    not have access to.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="EntryNotFoundError"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.EntryNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">EntryNotFoundError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when trying to access a hf.co URL with a valid repository and revision but an invalid filename.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="RevisionNotFoundError"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.RevisionNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">RevisionNotFoundError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when trying to access a hf.co URL with a valid repository but an invalid revision.&quot;&quot;&quot;</span></div>


<span class="k">def</span> <span class="nf">_raise_for_status</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal version of `request.raise_for_status()` that will refine a potential HTTPError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;X-Error-Code&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Error-Code&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;RepoNotFound&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RepositoryNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;404 Client Error: Repository Not Found for url: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;EntryNotFound&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EntryNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;404 Client Error: Entry Not Found for url: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s2">&quot;RevisionNotFound&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RevisionNotFoundError</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;404 Client Error: Revision Not Found for url: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="n">request</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>


<div class="viewcode-block" id="http_get"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.http_get">[docs]</a><span class="k">def</span> <span class="nf">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resume_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download remote file. Do not gobble up errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resume_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bytes=</span><span class="si">{</span><span class="n">resume_size</span><span class="si">}</span><span class="s2">-&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">_raise_for_status</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">resume_size</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span> <span class="k">if</span> <span class="n">content_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="c1"># `tqdm` behavior is determined by `utils.logging.is_progress_bar_enabled()`</span>
    <span class="c1"># and can be set using `utils.logging.enable/disable_progress_bar()`</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">resume_size</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>  <span class="c1"># filter out keep-alive new chunks</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_from_cache"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.get_from_cache">[docs]</a><span class="k">def</span> <span class="nf">get_from_cache</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">etag_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">resume_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a URL, look for the corresponding file in the local cache. If it&#39;s not there, download it. Then return the</span>
<span class="sd">    path to the cached file.</span>
<span class="sd">    Return:</span>
<span class="sd">        Local path (string) of file or if networking is off, last version of file cached on disk.</span>
<span class="sd">    Raises:</span>
<span class="sd">        In case of non-recoverable file (non-existent or inaccessible url + no cache on disk).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="n">http_user_agent</span><span class="p">(</span><span class="n">user_agent</span><span class="p">)}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_auth_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">use_auth_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">use_auth_token</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">HfFolder</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;You specified use_auth_token=True, but a huggingface token was not found.&quot;</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">url_to_download</span> <span class="o">=</span> <span class="n">url</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_files_only</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">etag_timeout</span><span class="p">)</span>
            <span class="n">_raise_for_status</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">etag</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Linked-Etag&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ETag&quot;</span><span class="p">)</span>
            <span class="c1"># We favor a custom header indicating the etag of the linked resource, and</span>
            <span class="c1"># we fallback to the regular etag header.</span>
            <span class="c1"># If we don&#39;t have any of those, raise an error.</span>
            <span class="k">if</span> <span class="n">etag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;Distant resource does not have an ETag, we won&#39;t be able to reliably ensure reproducibility.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># In case of a redirect,</span>
            <span class="c1"># save an extra redirect on the request.get call,</span>
            <span class="c1"># and ensure we download the exact atomic version even if it changed</span>
            <span class="c1"># between the HEAD and the GET (unlikely, but hey).</span>
            <span class="k">if</span> <span class="mi">300</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;=</span> <span class="mi">399</span><span class="p">:</span>
                <span class="n">url_to_download</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SSLError</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ProxyError</span><span class="p">):</span>
            <span class="c1"># Actually raise for those subclasses of ConnectionError</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="c1"># Otherwise, our Internet connection is down.</span>
            <span class="c1"># etag is None</span>
            <span class="k">pass</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">url_to_filename</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>

    <span class="c1"># get cache path to put the file</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># etag is None == we don&#39;t have a connection or we passed local_files_only.</span>
    <span class="c1"># try to get the last downloaded one</span>
    <span class="k">if</span> <span class="n">etag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cache_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matching_files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">file</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">),</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.lock&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">matching_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If files cannot be found and local_files_only=True,</span>
                <span class="c1"># the models might&#39;ve been found if local_files_only=False</span>
                <span class="c1"># Notify the user about that</span>
                <span class="k">if</span> <span class="n">local_files_only</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot find the requested files in the cached path and outgoing traffic has been&quot;</span>
                        <span class="s2">&quot; disabled. To enable model look-ups and downloads online, set &#39;local_files_only&#39;&quot;</span>
                        <span class="s2">&quot; to False.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Connection error, and we cannot find the requested files in the cached path.&quot;</span>
                        <span class="s2">&quot; Please try again or make sure your Internet connection is on.&quot;</span>
                    <span class="p">)</span>

    <span class="c1"># From now on, etag is not None.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache_path</span>

    <span class="c1"># Prevent parallel downloads of the same file with a lock.</span>
    <span class="n">lock_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span>
    <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">):</span>

        <span class="c1"># If the download just completed while the lock was activated.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
            <span class="c1"># Even if returning early like here, the lock will be released.</span>
            <span class="k">return</span> <span class="n">cache_path</span>

        <span class="k">if</span> <span class="n">resume_download</span><span class="p">:</span>
            <span class="n">incomplete_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.incomplete&quot;</span>

            <span class="nd">@contextmanager</span>
            <span class="k">def</span> <span class="nf">_resumable_file_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;io.BufferedWriter&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">incomplete_path</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">f</span>

            <span class="n">temp_file_manager</span> <span class="o">=</span> <span class="n">_resumable_file_manager</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">incomplete_path</span><span class="p">):</span>
                <span class="n">resume_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">incomplete_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resume_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_file_manager</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resume_size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Download to temporary file, then copy to cache dir once finished.</span>
        <span class="c1"># Otherwise you get corrupt cache entries if the download gets interrupted.</span>
        <span class="k">with</span> <span class="n">temp_file_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> not found in cache or force_download set to True, downloading to </span><span class="si">{</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">http_get</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">resume_size</span><span class="o">=</span><span class="n">resume_size</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;storing </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> in cache at </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">)</span>

        <span class="c1"># NamedTemporaryFile creates a file with hardwired 0600 perms (ignoring umask), so fixing it.</span>
        <span class="n">umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mo">0o666</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">umask</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="mo">0o666</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">umask</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating metadata file for </span><span class="si">{</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s2">&quot;etag&quot;</span><span class="p">:</span> <span class="n">etag</span><span class="p">}</span>
        <span class="n">meta_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">meta_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cache_path</span></div>


<div class="viewcode-block" id="get_file_from_repo"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.get_file_from_repo">[docs]</a><span class="k">def</span> <span class="nf">get_file_from_repo</span><span class="p">(</span>
    <span class="n">path_or_repo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">force_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">resume_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to locate a file in a local folder and repo, downloads and cache it if necessary.</span>
<span class="sd">    Args:</span>
<span class="sd">        path_or_repo (`str` or `os.PathLike`):</span>
<span class="sd">            This can be either:</span>
<span class="sd">            - a string, the *model id* of a model repo on huggingface.co.</span>
<span class="sd">            - a path to a *directory* potentially containing the file.</span>
<span class="sd">        filename (`str`):</span>
<span class="sd">            The name of the file to locate in `path_or_repo`.</span>
<span class="sd">        cache_dir (`str` or `os.PathLike`, *optional*):</span>
<span class="sd">            Path to a directory in which a downloaded pretrained model configuration should be cached if the standard</span>
<span class="sd">            cache should not be used.</span>
<span class="sd">        force_download (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether or not to force to (re-)download the configuration files and override the cached versions if they</span>
<span class="sd">            exist.</span>
<span class="sd">        resume_download (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether or not to delete incompletely received file. Attempts to resume the download if such a file exists.</span>
<span class="sd">        proxies (`Dict[str, str]`, *optional*):</span>
<span class="sd">            A dictionary of proxy servers to use by protocol or endpoint, e.g., `{&#39;http&#39;: &#39;foo.bar:3128&#39;,</span>
<span class="sd">            &#39;http://hostname&#39;: &#39;foo.bar:4012&#39;}.` The proxies are used on each request.</span>
<span class="sd">        use_auth_token (`str` or *bool*, *optional*):</span>
<span class="sd">            The token to use as HTTP bearer authorization for remote files. If `True`, will use the token generated</span>
<span class="sd">            when running `transformers-cli login` (stored in `~/.huggingface`).</span>
<span class="sd">        revision(`str`, *optional*, defaults to `&quot;main&quot;`):</span>
<span class="sd">            The specific model version to use. It can be a branch name, a tag name, or a commit id, since we use a</span>
<span class="sd">            git-based system for storing models and other artifacts on huggingface.co, so `revision` can be any</span>
<span class="sd">            identifier allowed by git.</span>
<span class="sd">        local_files_only (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            If `True`, will only try to load the tokenizer configuration from local files.</span>
<span class="sd">    &lt;Tip&gt;</span>
<span class="sd">    Passing `use_auth_token=True` is required when you want to use a private model.</span>
<span class="sd">    &lt;/Tip&gt;</span>
<span class="sd">    Returns:</span>
<span class="sd">        `Optional[str]`: Returns the resolved file (to the cache folder if downloaded from a repo) or `None` if the</span>
<span class="sd">        file does not exist.</span>
<span class="sd">    Examples:</span>
<span class="sd">    ```python</span>
<span class="sd">    # Download a tokenizer configuration from huggingface.co and cache.</span>
<span class="sd">    tokenizer_config = get_file_from_repo(&quot;bert-base-uncased&quot;, &quot;tokenizer_config.json&quot;)</span>
<span class="sd">    # This model does not have a tokenizer config so the result will be None.</span>
<span class="sd">    tokenizer_config = get_file_from_repo(&quot;xlm-roberta-base&quot;, &quot;tokenizer_config.json&quot;)</span>
<span class="sd">    ```&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_offline_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">local_files_only</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Offline mode: forcing local_files_only=True&quot;</span><span class="p">)</span>
        <span class="n">local_files_only</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">path_or_repo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">):</span>
        <span class="n">resolved_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolved_file</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">resolved_file</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resolved_file</span> <span class="o">=</span> <span class="n">hf_bucket_url</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">mirror</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load from URL or cache if already cached</span>
        <span class="n">resolved_file</span> <span class="o">=</span> <span class="n">cached_path</span><span class="p">(</span>
            <span class="n">resolved_file</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
            <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
            <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
            <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
            <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">RepositoryNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_or_repo</span><span class="si">}</span><span class="s2"> is not a local folder and is not a valid model identifier &quot;</span>
            <span class="s2">&quot;listed on &#39;https://huggingface.co/models&#39;</span><span class="se">\n</span><span class="s2">If this is a private repository, make sure to &quot;</span>
            <span class="s2">&quot;pass a token having permission to this repo with `use_auth_token` or log in with &quot;</span>
            <span class="s2">&quot;`huggingface-cli login` and pass `use_auth_token=True`.&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">RevisionNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">revision</span><span class="si">}</span><span class="s2"> is not a valid git identifier (branch name, tag name or commit id) that exists &quot;</span>
            <span class="s2">&quot;for this model name. Check the model page at &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;https://huggingface.co/</span><span class="si">{</span><span class="n">path_or_repo</span><span class="si">}</span><span class="s2">&#39; for available revisions.&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
        <span class="c1"># The repo and revision exist, but the file does not or there was a connection error fetching it.</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">resolved_file</span></div>


<div class="viewcode-block" id="has_file"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.has_file">[docs]</a><span class="k">def</span> <span class="nf">has_file</span><span class="p">(</span>
    <span class="n">path_or_repo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mirror</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a repo contains a given file wihtout downloading it. Works for remote repos and local folders.</span>
<span class="sd">    &lt;Tip warning={false}&gt;</span>
<span class="sd">    This function will raise an error if the repository `path_or_repo` is not valid or if `revision` does not exist for</span>
<span class="sd">    this repo, but will return False for regular connection errors.</span>
<span class="sd">    &lt;/Tip&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">hf_bucket_url</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">mirror</span><span class="o">=</span><span class="n">mirror</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="n">http_user_agent</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_auth_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">use_auth_token</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">use_auth_token</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">HfFolder</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;You specified use_auth_token=True, but a huggingface token was not found.&quot;</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_raise_for_status</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">RepositoryNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_or_repo</span><span class="si">}</span><span class="s2"> is not a local folder or a valid repository name on &#39;https://hf.co&#39;.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">RevisionNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">revision</span><span class="si">}</span><span class="s2"> is not a valid git identifier (branch name, tag name or commit id) that exists for this &quot;</span>
            <span class="s2">&quot;model name. Check the model page at &#39;https://huggingface.co/</span><span class="si">{path_or_repo}</span><span class="s2">&#39; for available revisions.&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
        <span class="c1"># We return false for EntryNotFoundError (logical) as well as any connection error.</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_list_of_files"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.get_list_of_files">[docs]</a><span class="k">def</span> <span class="nf">get_list_of_files</span><span class="p">(</span>
    <span class="n">path_or_repo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
    <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the list of files inside `path_or_repo`.</span>
<span class="sd">    Args:</span>
<span class="sd">        path_or_repo (`str` or `os.PathLike`):</span>
<span class="sd">            Can be either the id of a repo on huggingface.co or a path to a *directory*.</span>
<span class="sd">        revision (`str`, *optional*, defaults to `&quot;main&quot;`):</span>
<span class="sd">            The specific model version to use. It can be a branch name, a tag name, or a commit id, since we use a</span>
<span class="sd">            git-based system for storing models and other artifacts on huggingface.co, so `revision` can be any</span>
<span class="sd">            identifier allowed by git.</span>
<span class="sd">        use_auth_token (`str` or *bool*, *optional*):</span>
<span class="sd">            The token to use as HTTP bearer authorization for remote files. If `True`, will use the token generated</span>
<span class="sd">            when running `transformers-cli login` (stored in `~/.huggingface`).</span>
<span class="sd">        local_files_only (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether or not to only rely on local files and not to attempt to download any files.</span>
<span class="sd">    &lt;Tip warning={true}&gt;</span>
<span class="sd">    This API is not optimized, so calling it a lot may result in connection errors.</span>
<span class="sd">    &lt;/Tip&gt;</span>
<span class="sd">    Returns:</span>
<span class="sd">        `List[str]`: The list of files available in `path_or_repo`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_or_repo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">)</span>
    <span class="c1"># If path_or_repo is a folder, we just return what is inside (subdirectories included).</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">):</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">,</span> <span class="n">file_names</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">):</span>
            <span class="n">list_of_files</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">list_of_files</span>

    <span class="c1"># Can&#39;t grab the files if we are on offline mode.</span>
    <span class="k">if</span> <span class="n">is_offline_mode</span><span class="p">()</span> <span class="ow">or</span> <span class="n">local_files_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Otherwise we grab the token and use the list_repo_files method.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_auth_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">use_auth_token</span>
    <span class="k">elif</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">HfFolder</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">list_repo_files</span><span class="p">(</span><span class="n">path_or_repo</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path_or_repo</span><span class="si">}</span><span class="s2"> is not a local path or a model identifier on the model Hub. Did you make a typo?&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<div class="viewcode-block" id="cached_property"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.cached_property">[docs]</a><span class="k">class</span> <span class="nc">cached_property</span><span class="p">(</span><span class="nb">property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Descriptor that mimics @property but caches output in member variable.</span>
<span class="sd">    From tensorflow_datasets</span>
<span class="sd">    Built-in in functools from Python 3.8.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># See docs.python.org/3/howto/descriptor.html#properties</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;unreadable attribute&quot;</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;__cached_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">cached</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached</span></div>


<div class="viewcode-block" id="torch_required"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.torch_required">[docs]</a><span class="k">def</span> <span class="nf">torch_required</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c1"># Chose a different decorator name than in tests so it&#39;s clear they are not the same.</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method `</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` requires PyTorch.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="tf_required"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.tf_required">[docs]</a><span class="k">def</span> <span class="nf">tf_required</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c1"># Chose a different decorator name than in tests so it&#39;s clear they are not the same.</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_tf_available</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method `</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` requires TF.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="is_torch_fx_proxy"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_torch_fx_proxy">[docs]</a><span class="k">def</span> <span class="nf">is_torch_fx_proxy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_torch_fx_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">torch.fx</span>

        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">fx</span><span class="o">.</span><span class="n">Proxy</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_tensor"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_tensor">[docs]</a><span class="k">def</span> <span class="nf">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests if `x` is a `torch.Tensor`, `tf.Tensor`, `jaxlib.xla_extension.DeviceArray` or `np.ndarray`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_torch_fx_proxy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">is_tf_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">is_flax_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
        <span class="kn">from</span> <span class="nn">jax.core</span> <span class="kn">import</span> <span class="n">Tracer</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tracer</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_is_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_torch</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_torch_device</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_tensorflow</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_jax</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>  <span class="c1"># noqa: F811</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>


<div class="viewcode-block" id="to_py_obj"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.to_py_obj">[docs]</a><span class="k">def</span> <span class="nf">to_py_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a TensorFlow tensor, PyTorch tensor, Numpy array or python list to a python list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">UserDict</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">to_py_obj</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">to_py_obj</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">is_tf_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_is_tensorflow</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">is_torch_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_is_torch</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">is_flax_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_is_jax</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)):</span>  <span class="c1"># tolist also works on 0d np arrays</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="to_numpy"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.to_numpy">[docs]</a><span class="k">def</span> <span class="nf">to_numpy</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a TensorFlow tensor, PyTorch tensor, Numpy array or python list to a Numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">UserDict</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">to_numpy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_tf_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_is_tensorflow</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">is_torch_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_is_torch</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">is_flax_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_is_jax</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="ModelOutput"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ModelOutput">[docs]</a><span class="k">class</span> <span class="nc">ModelOutput</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all model outputs as dataclass. Has a `__getitem__` that allows indexing by integer or slice (like a</span>
<span class="sd">    tuple) or strings (like a dictionary) that will ignore the `None` attributes. Otherwise behaves like a regular</span>
<span class="sd">    python dictionary.</span>
<span class="sd">    &lt;Tip warning={true}&gt;</span>
<span class="sd">    You can&#39;t unpack a `ModelOutput` directly. Use the [`~file_utils.ModelOutput.to_tuple`] method to convert it to a</span>
<span class="sd">    tuple before.</span>
<span class="sd">    &lt;/Tip&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">class_fields</span> <span class="o">=</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Safety and consistency checks</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_fields</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no fields.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">class_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> should not have more than one required field.&quot;</span><span class="p">)</span>

        <span class="n">first_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">other_fields_are_none</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">class_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">other_fields_are_none</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_tensor</span><span class="p">(</span><span class="n">first_field</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">first_field</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="n">first_field_iterator</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">first_field</span><span class="p">)</span>
                    <span class="n">first_field_iterator</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">first_field_iterator</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># if we provided an iterator as first field and the iterator is a (key, value) iterator</span>
            <span class="c1"># set the associated fields</span>
            <span class="k">if</span> <span class="n">first_field_iterator</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">break</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">first_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">class_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">class_fields</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``__delitem__`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ModelOutput.setdefault"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ModelOutput.setdefault">[docs]</a>    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``setdefault`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelOutput.pop"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ModelOutput.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``pop`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelOutput.update"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ModelOutput.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``update`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">inner_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">inner_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Don&#39;t call self.__setitem__ to avoid recursion errors</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Will raise a KeyException if needed</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Don&#39;t call self.__setattr__ to avoid recursion errors</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ModelOutput.to_tuple"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ModelOutput.to_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert self to a tuple containing all the attributes/keys that are not `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="ExplicitEnum"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ExplicitEnum">[docs]</a><span class="k">class</span> <span class="nc">ExplicitEnum</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enum with more explicit error message for missing values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_missing_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a valid </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, please select one of </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value2member_map_</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PaddingStrategy"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.PaddingStrategy">[docs]</a><span class="k">class</span> <span class="nc">PaddingStrategy</span><span class="p">(</span><span class="n">ExplicitEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Possible values for the `padding` argument in [`PreTrainedTokenizerBase.__call__`]. Useful for tab-completion in an</span>
<span class="sd">    IDE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LONGEST</span> <span class="o">=</span> <span class="s2">&quot;longest&quot;</span>
    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="s2">&quot;max_length&quot;</span>
    <span class="n">DO_NOT_PAD</span> <span class="o">=</span> <span class="s2">&quot;do_not_pad&quot;</span></div>


<div class="viewcode-block" id="TensorType"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.TensorType">[docs]</a><span class="k">class</span> <span class="nc">TensorType</span><span class="p">(</span><span class="n">ExplicitEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Possible values for the `return_tensors` argument in [`PreTrainedTokenizerBase.__call__`]. Useful for</span>
<span class="sd">    tab-completion in an IDE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PYTORCH</span> <span class="o">=</span> <span class="s2">&quot;pt&quot;</span>
    <span class="n">TENSORFLOW</span> <span class="o">=</span> <span class="s2">&quot;tf&quot;</span>
    <span class="n">NUMPY</span> <span class="o">=</span> <span class="s2">&quot;np&quot;</span>
    <span class="n">JAX</span> <span class="o">=</span> <span class="s2">&quot;jax&quot;</span></div>


<span class="k">class</span> <span class="nc">_LazyModule</span><span class="p">(</span><span class="n">ModuleType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Module class that surfaces all objects but only performs associated imports when the objects are requested.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Very heavily inspired by optuna.integration._IntegrationModule</span>
    <span class="c1"># https://github.com/optuna/optuna/blob/master/optuna/integration/__init__.py</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module_file</span><span class="p">,</span> <span class="n">import_structure</span><span class="p">,</span> <span class="n">module_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">import_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">import_structure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="c1"># Needed for autocompletion in an IDE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all__</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">import_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">import_structure</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="n">module_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__spec__</span> <span class="o">=</span> <span class="n">module_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">module_file</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objects</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">extra_objects</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extra_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_structure</span> <span class="o">=</span> <span class="n">import_structure</span>

    <span class="c1"># Needed for autocompletion in an IDE</span>
    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span>
        <span class="c1"># The elements of self.__all__ that are submodules may or may not be in the dir already, depending on whether</span>
        <span class="c1"># they have been accessed or not. So we only add the elements of self.__all__ that are not already in the dir.</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objects</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objects</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;module </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no attribute </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">module_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to import </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> because of the following error (look up to see its traceback):</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_structure</span><span class="p">))</span>


<div class="viewcode-block" id="copy_func"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.copy_func">[docs]</a><span class="k">def</span> <span class="nf">copy_func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a copy of a function f.&quot;&quot;&quot;</span>
    <span class="c1"># Based on http://stackoverflow.com/a/6528148/190597 (Glenn Maynard)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__code__</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">argdefs</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">,</span> <span class="n">closure</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="vm">__kwdefaults__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__kwdefaults__</span>
    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="is_local_clone"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.is_local_clone">[docs]</a><span class="k">def</span> <span class="nf">is_local_clone</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the folder in `repo_path` is a local clone of `repo_url`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First double-check that `repo_path` is a git repo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">test_git</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;git branch&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">cwd</span><span class="o">=</span><span class="n">repo_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_git</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Then look at its remotes</span>
    <span class="n">remotes</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s2">&quot;git remote -v&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">repo_path</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

    <span class="k">return</span> <span class="n">repo_url</span> <span class="ow">in</span> <span class="n">remotes</span><span class="o">.</span><span class="n">split</span><span class="p">()</span></div>


<div class="viewcode-block" id="PushToHubMixin"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.PushToHubMixin">[docs]</a><span class="k">class</span> <span class="nc">PushToHubMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Mixin containing the functionality to push a model or tokenizer to the hub.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PushToHubMixin.push_to_hub"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.PushToHubMixin.push_to_hub">[docs]</a>    <span class="k">def</span> <span class="nf">push_to_hub</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repo_path_or_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_temp_dir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">commit_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">organization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">private</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">model_card_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload the {object_files} to the 🤗 Model Hub while synchronizing a local clone of the repo in</span>
<span class="sd">        `repo_path_or_name`.</span>
<span class="sd">        Parameters:</span>
<span class="sd">            repo_path_or_name (`str`, *optional*):</span>
<span class="sd">                Can either be a repository name for your {object} in the Hub or a path to a local folder (in which case</span>
<span class="sd">                the repository will have the name of that local folder). If not specified, will default to the name</span>
<span class="sd">                given by `repo_url` and a local directory with that name will be created.</span>
<span class="sd">            repo_url (`str`, *optional*):</span>
<span class="sd">                Specify this in case you want to push to an existing repository in the hub. If unspecified, a new</span>
<span class="sd">                repository will be created in your namespace (unless you specify an `organization`) with `repo_name`.</span>
<span class="sd">            use_temp_dir (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                Whether or not to clone the distant repo in a temporary directory or in `repo_path_or_name` inside the</span>
<span class="sd">                current working directory. This will slow things down if you are making changes in an existing repo</span>
<span class="sd">                since you will need to clone the repo before every push.</span>
<span class="sd">            commit_message (`str`, *optional*):</span>
<span class="sd">                Message to commit while pushing. Will default to `&quot;add {object}&quot;`.</span>
<span class="sd">            organization (`str`, *optional*):</span>
<span class="sd">                Organization in which you want to push your {object} (you must be a member of this organization).</span>
<span class="sd">            private (`bool`, *optional*):</span>
<span class="sd">                Whether or not the repository created should be private (requires a paying subscription).</span>
<span class="sd">            use_auth_token (`bool` or `str`, *optional*):</span>
<span class="sd">                The token to use as HTTP bearer authorization for remote files. If `True`, will use the token generated</span>
<span class="sd">                when running `transformers-cli login` (stored in `~/.huggingface`). Will default to `True` if</span>
<span class="sd">                `repo_url` is not specified.</span>
<span class="sd">        Returns:</span>
<span class="sd">            `str`: The url of the commit of your {object} in the given repository.</span>
<span class="sd">        Examples:</span>
<span class="sd">        ```python</span>
<span class="sd">        from transformers import {object_class}</span>
<span class="sd">        {object} = {object_class}.from_pretrained(&quot;bert-base-cased&quot;)</span>
<span class="sd">        # Push the {object} to your namespace with the name &quot;my-finetuned-bert&quot; and have a local clone in the</span>
<span class="sd">        # *my-finetuned-bert* folder.</span>
<span class="sd">        {object}.push_to_hub(&quot;my-finetuned-bert&quot;)</span>
<span class="sd">        # Push the {object} to your namespace with the name &quot;my-finetuned-bert&quot; with no local clone.</span>
<span class="sd">        {object}.push_to_hub(&quot;my-finetuned-bert&quot;, use_temp_dir=True)</span>
<span class="sd">        # Push the {object} to an organization with the name &quot;my-finetuned-bert&quot; and have a local clone in the</span>
<span class="sd">        # *my-finetuned-bert* folder.</span>
<span class="sd">        {object}.push_to_hub(&quot;my-finetuned-bert&quot;, organization=&quot;huggingface&quot;)</span>
<span class="sd">        # Make a change to an existing repo that has been cloned locally in *my-finetuned-bert*.</span>
<span class="sd">        {object}.push_to_hub(&quot;my-finetuned-bert&quot;, repo_url=&quot;https://huggingface.co/sgugger/my-finetuned-bert&quot;)</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_temp_dir</span><span class="p">:</span>
            <span class="c1"># Make sure we use the right `repo_name` for the `repo_url` before replacing it.</span>
            <span class="k">if</span> <span class="n">repo_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">use_auth_token</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">repo_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repo_url_from_name</span><span class="p">(</span>
                    <span class="n">repo_name</span><span class="p">,</span> <span class="n">organization</span><span class="o">=</span><span class="n">organization</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="n">private</span><span class="p">,</span> <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span>
                <span class="p">)</span>
            <span class="n">repo_path_or_name</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="c1"># Create or clone the repo. If the repo is already cloned, this just retrieves the path to the repo.</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_get_repo</span><span class="p">(</span>
            <span class="n">repo_path_or_name</span><span class="o">=</span><span class="n">repo_path_or_name</span><span class="p">,</span>
            <span class="n">repo_url</span><span class="o">=</span><span class="n">repo_url</span><span class="p">,</span>
            <span class="n">organization</span><span class="o">=</span><span class="n">organization</span><span class="p">,</span>
            <span class="n">private</span><span class="o">=</span><span class="n">private</span><span class="p">,</span>
            <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Save the files in the cloned repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;create_model_card&quot;</span><span class="p">):</span>
            <span class="c1"># This is a Keras model and we might be able to fish out its History and make a model card out of it</span>
            <span class="n">base_model_card_args</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">repo_path_or_name</span><span class="p">,</span>
                <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">base_model_card_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_card_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_model_card</span><span class="p">(</span><span class="o">**</span><span class="n">base_model_card_args</span><span class="p">)</span>
        <span class="c1"># Commit and push!</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_push_to_hub</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">)</span>

        <span class="c1"># Clean up! Clean up! Everybody everywhere!</span>
        <span class="k">if</span> <span class="n">use_temp_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">url</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_repo_url_from_name</span><span class="p">(</span>
        <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">organization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">private</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_auth_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">use_auth_token</span>
        <span class="k">elif</span> <span class="n">use_auth_token</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">HfFolder</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;You must login to the Hugging Face hub on this computer by typing `transformers-cli login` and &quot;</span>
                    <span class="s2">&quot;entering your credentials to use `use_auth_token=True`. Alternatively, you can pass your own &quot;</span>
                    <span class="s2">&quot;token as the `use_auth_token` argument.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Special provision for the test endpoint (CI)</span>
        <span class="k">return</span> <span class="n">create_repo</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">repo_name</span><span class="p">,</span>
            <span class="n">organization</span><span class="o">=</span><span class="n">organization</span><span class="p">,</span>
            <span class="n">private</span><span class="o">=</span><span class="n">private</span><span class="p">,</span>
            <span class="n">repo_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_or_get_repo</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">repo_path_or_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">repo_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">organization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">private</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Repository</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">repo_path_or_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">repo_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify a `repo_path_or_name` or a `repo_url`.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_auth_token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">repo_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_auth_token</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">repo_path_or_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repo_path_or_name</span> <span class="o">=</span> <span class="n">repo_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">repo_url</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">):</span>
            <span class="n">repo_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">repo_url</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_repo_url_from_name</span><span class="p">(</span>
                <span class="n">repo_name</span><span class="p">,</span> <span class="n">organization</span><span class="o">=</span><span class="n">organization</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="n">private</span><span class="p">,</span> <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span>
            <span class="p">)</span>

        <span class="c1"># Create a working directory if it does not exist.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">)</span>

        <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">repo_path_or_name</span><span class="p">,</span> <span class="n">clone_from</span><span class="o">=</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">git_pull</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">repo</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_push_to_hub</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">Repository</span><span class="p">,</span> <span class="n">commit_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">commit_message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Tokenizer&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                <span class="n">commit_message</span> <span class="o">=</span> <span class="s2">&quot;add tokenizer&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;Config&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                <span class="n">commit_message</span> <span class="o">=</span> <span class="s2">&quot;add config&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commit_message</span> <span class="o">=</span> <span class="s2">&quot;add model&quot;</span>

        <span class="k">return</span> <span class="n">repo</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="n">commit_message</span><span class="o">=</span><span class="n">commit_message</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_full_repo_name"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.get_full_repo_name">[docs]</a><span class="k">def</span> <span class="nf">get_full_repo_name</span><span class="p">(</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">organization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">HfFolder</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">organization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">whoami</span><span class="p">(</span><span class="n">token</span><span class="p">)[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">organization</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="ContextManagers"><a class="viewcode-back" href="../../../../../../deepke.name_entity_re.multimodal.models.clip.html#deepke.name_entity_re.multimodal.models.clip.file_utils.ContextManagers">[docs]</a><span class="k">class</span> <span class="nc">ContextManagers</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for `contextlib.ExitStack` which enters a collection of context managers. Adaptation of `ContextManagers`</span>
<span class="sd">    in the `fastcore` library.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_managers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ContextManager</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_managers</span> <span class="o">=</span> <span class="n">context_managers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">ExitStack</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">context_manager</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_managers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">context_manager</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, ZJUNLP.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>